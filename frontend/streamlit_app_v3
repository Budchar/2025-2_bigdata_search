import streamlit as st
import requests
import time 
import json 
import uuid 

# -----------------------------------------------------------------
# 1. ì„¤ì •
# -----------------------------------------------------------------

# FastAPI ë°±ì—”ë“œ ì£¼ì†Œ (main.pyê°€ ì‹¤í–‰ë˜ëŠ” ê³³) - ì‹¤ì œ ì—°ë™ ì£¼ì†Œ
BACKEND_BASE_URL = "http://127.0.0.1:8000/agent"
BACKEND_QUERY_URL = f"{BACKEND_BASE_URL}/query" # ê²€ìƒ‰ ë° RAG
# âš ï¸ ë°±ì—”ë“œ main.pyì— translate_summary ì—”ë“œí¬ì¸íŠ¸ê°€ êµ¬í˜„ë˜ì§€ ì•Šì•„ ì£¼ì„ ì²˜ë¦¬í•¨.
# BACKEND_TRANSLATE_URL = f"{BACKEND_BASE_URL}/translate_summary" 

# Streamlit í˜ì´ì§€ ì„¤ì • - í˜ì´ì§€ ì œëª©ê³¼ ì•„ì´ì½˜ ì„¤ì •
st.set_page_config(page_title="ë…¼ë¬¸ ê²€ìƒ‰ AI ì—ì´ì „íŠ¸", page_icon="ğŸ“„", layout="wide")
st.title("ğŸ“„ Agentic RAG ê¸°ë°˜ ë…¼ë¬¸ ê²€ìƒ‰ ë° ë¶„ì„ ë„êµ¬")

# -----------------------------------------------------------------
# 2. ë©€í‹°í„´(Multi-turn)ì„ ìœ„í•œ ì„¸ì…˜ ìƒíƒœ ê´€ë¦¬
# -----------------------------------------------------------------

if "messages" not in st.session_state:
    st.session_state.messages = []
# âš ï¸ í˜„ì¬ ë°±ì—”ë“œëŠ” "mode"ë¥¼ ì²˜ë¦¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ë‚˜ë¨¸ì§€ ìƒíƒœ ë³€ìˆ˜ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.


# -----------------------------------------------------------------
# 3. ì‚¬ì´ë“œë°” êµ¬ì„± (í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ ì˜µì…˜)
# -----------------------------------------------------------------
# âš ï¸ ë°±ì—”ë“œ main.pyì˜ /agent/query ì—”ë“œí¬ì¸íŠ¸ëŠ” ëª¨ë“œ ì„¤ì •ì„ ì²˜ë¦¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ëª¨ë‘ ì£¼ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
# def clear_chat_history_on_mode_change():
#     # ... (í•¨ìˆ˜ ë‚´ìš© ì£¼ì„ ì²˜ë¦¬)
#     pass

# st.sidebar.header("ğŸ” ê²€ìƒ‰ ëª¨ë“œ ì„¤ì •")
# selected_mode = st.sidebar.radio(
#     # ... (ë¼ë””ì˜¤ ë²„íŠ¼ ë‚´ìš© ì£¼ì„ ì²˜ë¦¬)
# )
# st.sidebar.markdown("""
# # ... (ì„¤ëª… ë‚´ìš© ì£¼ì„ ì²˜ë¦¬)
# # """)


# -----------------------------------------------------------------
# 4. ë…¼ë¬¸ ìš”ì•½/ë²ˆì—­ ìš”ì²­ í•¸ë“¤ëŸ¬ (API ì—°ë™)
# -----------------------------------------------------------------
# âš ï¸ ë°±ì—”ë“œ main.pyì— translate_summary ì—”ë“œí¬ì¸íŠ¸ê°€ êµ¬í˜„ë˜ì§€ ì•Šì•„ ì£¼ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
# def request_translation(paper_id, expander_title):
#     # ... (í•¨ìˆ˜ ë‚´ìš© ì£¼ì„ ì²˜ë¦¬)
#     pass


# -----------------------------------------------------------------
# 5. ë…¼ë¬¸ ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜ 
# -----------------------------------------------------------------
# âš ï¸ í˜„ì¬ ë°±ì—”ë“œëŠ” êµ¬ì¡°í™”ëœ ë…¼ë¬¸ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•˜ì§€ ì•Šì•„ ì£¼ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
# def display_papers(papers, message_index): 
#     # ... (í•¨ìˆ˜ ë‚´ìš© ì£¼ì„ ì²˜ë¦¬)
#     pass


# -----------------------------------------------------------------
# 6. ì±„íŒ… UI êµ¬ì„± (ë©”ì¸ í™”ë©´) (API ì—°ë™)
# -----------------------------------------------------------------

# (A) ì €ì¥ëœ ë©”ì‹œì§€(st.session_state.messages)ë¥¼ ìˆœíšŒí•˜ë©° í™”ë©´ì— ì¶œë ¥
for msg_idx, message in enumerate(st.session_state.messages): 
    with st.chat_message(message["role"]):
        # âš ï¸ ë°±ì—”ë“œëŠ” ë‹¨ìˆœ ë¬¸ìì—´ë§Œ ë°˜í™˜í•˜ë¯€ë¡œ, 'content'ê°€ ë”•ì…”ë„ˆë¦¬ì¸ ê²½ìš° 'result' í‚¤ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
        if isinstance(message["content"], dict):
            # ë°±ì—”ë“œê°€ ë°˜í™˜í•˜ëŠ” 'result' í‚¤ì—ì„œ ìµœì¢… ì—ì´ì „íŠ¸ ë‹µë³€ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
            agent_output_text = message["content"].get("result") 
            
            if agent_output_text:
                st.markdown(agent_output_text) 
            else:
                 st.markdown("ì—ì´ì „íŠ¸ë¡œë¶€í„° ìœ íš¨í•œ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")

        else:
            st.markdown(message["content"])

# (B) ì‚¬ìš©ì ì…ë ¥ ë°›ê¸°
if prompt := st.chat_input("ë…¼ë¬¸ì— ëŒ€í•´ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”."):
    
    # 1. ì‚¬ìš©ìì˜ ë©”ì‹œì§€ë¥¼ ì„¸ì…˜ì— ì¶”ê°€
    st.session_state.messages.append({"role": "user", "content": prompt})
    
    # 2. ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶œë ¥ (ì¦‰ê°ì ì¸ í”¼ë“œë°±)
    with st.chat_message("user"):
        st.markdown(prompt)

    # 3. AI ì‘ë‹µ ì²˜ë¦¬
    with st.chat_message("assistant"):
        st.toast(f"â³ ë°±ì—”ë“œ APIë¡œ ì¿¼ë¦¬ë¥¼ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...") 
        
        response_placeholder = st.empty()
        response_placeholder.markdown("ì²˜ë¦¬ ì¤‘...") # API í˜¸ì¶œ ì „ ë¡œë”© ë©”ì‹œì§€
        
        try:
            # --- ğŸš€ í•µì‹¬ ìˆ˜ì • ë¶€ë¶„: Payload Key 'message' ì‚¬ìš© ---
            payload = {
                "message": prompt,
                # "mode": st.session_state.search_mode # ë°±ì—”ë“œ ë¯¸êµ¬í˜„ìœ¼ë¡œ ì œê±°
            }
            
            response = requests.post(
                BACKEND_QUERY_URL,
                json=payload,
                timeout=60 # RAGëŠ” ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìœ¼ë¯€ë¡œ 60ì´ˆ íƒ€ì„ì•„ì›ƒ ì„¤ì •
            )
            response.raise_for_status() 
            ai_response_dict = response.json()
            # ---------------------------------
            
            # 4. AIì˜ ì „ì²´ ì‘ë‹µ(ë”•ì…”ë„ˆë¦¬)ì„ ì„¸ì…˜ì— ì €ì¥
            st.session_state.messages.append({"role": "assistant", "content": ai_response_dict})

            # 5. LLM ë‹µë³€ì„ íƒ€ì´í•‘ íš¨ê³¼ë¡œ ì¶œë ¥
            # --- ğŸš€ í•µì‹¬ ìˆ˜ì • ë¶€ë¶„: ì‘ë‹µ Key 'result' ì‚¬ìš© ---
            # ë°±ì—”ë“œ main.pyê°€ ë°˜í™˜í•˜ëŠ” 'result' í‚¤ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            ai_answer_text = ai_response_dict.get("result", "ë…¼ë¬¸ ê²€ìƒ‰ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
            
            full_response = ""
            # íƒ€ì´í•‘ íš¨ê³¼ë¡œ ì¶œë ¥
            for chunk in ai_answer_text.split():
                full_response += chunk + " "
                time.sleep(0.01) # ì§§ì€ ë”œë ˆì´ë§Œ ì ìš©
                response_placeholder.markdown(full_response + "â–Œ")
            response_placeholder.markdown(full_response)
            
            st.toast("âœ… ì‘ë‹µ ìˆ˜ì‹  ì™„ë£Œ!")

        except requests.exceptions.Timeout:
            error_message = "âŒ ê²€ìƒ‰ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë°±ì—”ë“œ(LLM/RAG) ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."
            st.error(error_message)
            st.session_state.messages.append({"role": "assistant", "content": {"result": error_message}})
            response_placeholder.markdown(error_message)
        except requests.exceptions.RequestException as e:
            error_message = f"âŒ ê²€ìƒ‰ ìš”ì²­ ì¤‘ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}"
            st.error(error_message)
            st.session_state.messages.append({"role": "assistant", "content": {"result": error_message}})
            response_placeholder.markdown(error_message)
        except json.JSONDecodeError:
            error_message = "âŒ ë°±ì—”ë“œë¡œë¶€í„° ìœ íš¨í•œ JSON ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
            st.error(error_message)
            st.session_state.messages.append({"role": "assistant", "content": {"result": error_message}})
            response_placeholder.markdown(error_message)
        except Exception as e:
            error_message = f"âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}"
            st.error(error_message)
            st.session_state.messages.append({"role": "assistant", "content": {"result": error_message}})
            response_placeholder.markdown(error_message)
    
    # ì‘ë‹µ ì²˜ë¦¬ê°€ ì™„ë£Œëœ í›„ ì „ì²´ UIë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.
    st.rerun()